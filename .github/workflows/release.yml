name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libxcb-render0-dev libxcb-shape0-dev \
            libxcb-xfixes0-dev libxkbcommon-dev libssl-dev pkg-config
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Build release
        run: cargo build --release
      
      - name: Strip binary
        run: strip target/release/proxy-vm-wizard
      
      - name: Create tarball
        run: |
          mkdir -p dist
          cp target/release/proxy-vm-wizard dist/
          cp README.md LICENSE dist/
          cp -r assets dist/
          cp scripts/install.sh dist/
          cd dist && tar -czvf ../proxy-vm-wizard-linux-x86_64.tar.gz *
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: proxy-vm-wizard-linux-x86_64
          path: proxy-vm-wizard-linux-x86_64.tar.gz

  build-appimage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libxcb-render0-dev libxcb-shape0-dev \
            libxcb-xfixes0-dev libxkbcommon-dev libssl-dev pkg-config \
            libfuse2 file
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Build release
        run: cargo build --release
      
      - name: Download linuxdeploy
        run: |
          wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage
      
      - name: Create AppDir
        run: |
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/scalable/apps
          mkdir -p AppDir/usr/share/metainfo
          
          cp target/release/proxy-vm-wizard AppDir/usr/bin/
          cp assets/io.github.proxyvmwizard.ProxyVmWizard.desktop AppDir/usr/share/applications/
          cp assets/io.github.proxyvmwizard.ProxyVmWizard.svg AppDir/usr/share/icons/hicolor/scalable/apps/
          cp assets/io.github.proxyvmwizard.ProxyVmWizard.metainfo.xml AppDir/usr/share/metainfo/
      
      - name: Build AppImage
        run: |
          ./linuxdeploy-x86_64.AppImage --appdir AppDir --output appimage \
            --desktop-file assets/io.github.proxyvmwizard.ProxyVmWizard.desktop \
            --icon-file assets/io.github.proxyvmwizard.ProxyVmWizard.svg
          mv Proxy_VM_Wizard*.AppImage proxy-vm-wizard-x86_64.AppImage
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: proxy-vm-wizard-appimage
          path: proxy-vm-wizard-x86_64.AppImage

  build-deb:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libxcb-render0-dev libxcb-shape0-dev \
            libxcb-xfixes0-dev libxkbcommon-dev libssl-dev pkg-config dpkg-dev
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Build release
        run: cargo build --release
      
      - name: Install cargo-deb
        run: cargo install cargo-deb
      
      - name: Build .deb package
        run: cargo deb
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: proxy-vm-wizard-deb
          path: target/debian/*.deb

  create-release:
    needs: [build-linux, build-appimage, build-deb]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          draft: false
          prerelease: false
          files: |
            proxy-vm-wizard-linux-x86_64/proxy-vm-wizard-linux-x86_64.tar.gz
            proxy-vm-wizard-appimage/proxy-vm-wizard-x86_64.AppImage
            proxy-vm-wizard-deb/*.deb
          body: |
            ## Installation
            
            ### Option 1: AppImage (Easiest)
            ```bash
            chmod +x proxy-vm-wizard-x86_64.AppImage
            ./proxy-vm-wizard-x86_64.AppImage
            ```
            
            ### Option 2: Debian/Ubuntu (.deb)
            ```bash
            sudo dpkg -i proxy-vm-wizard_*.deb
            sudo apt-get install -f  # Install dependencies
            ```
            
            ### Option 3: Binary tarball
            ```bash
            tar -xzf proxy-vm-wizard-linux-x86_64.tar.gz
            sudo ./install.sh
            ```
            
            ### Prerequisites
            Make sure you have libvirt installed:
            ```bash
            sudo apt install libvirt-daemon-system libvirt-clients virtinst qemu-kvm
            sudo usermod -aG libvirt $USER
            ```


